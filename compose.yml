version: '3.8'

services:
  nginx:
    image: nginx:latest
    container_name: gateway
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./websocket.conf:/etc/nginx/websocket.conf:ro
      - ./certs:/etc/nginx/certs:ro
    ports:
      - "8080:8080"
      - "443:443"
    restart: unless-stopped
    networks:
      - app-network
    depends_on:
      - article-service
      - client-service
      - commande-service
      - livreur-service
      - menu-service
      - restaurateur-service
    extra_hosts:
      - "cesieat.com:127.0.0.1"

  dozzle:
    container_name: dozzle
    image: amir20/dozzle:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 8081:8080
    networks:
      - app-network
    restart: unless-stopped

  # Client frontend (Production)
  client-frontend-prod:
    build:
      context: .  # Utiliser la racine du monorepo comme contexte
      dockerfile: apps/client/Dockerfile.prod  # Chemin vers le Dockerfile dans la nouvelle structure
    container_name: clientFrontendProd
    ports:
      - "3080:80"
    restart: unless-stopped
    networks:
      - app-network
  
  # Restaurant frontend (Production)
  restaurateur-frontend-prod:
    build:
      context: .  # Utiliser la racine du monorepo comme contexte
      dockerfile: apps/restaurateur/Dockerfile.prod
    container_name: restaurateurFrontendProd
    ports:
      - "3081:80"
    restart: unless-stopped
    networks:
      - app-network
  
  # Livreur frontend (Production)
  livreur-frontend-prod:
    build:
      context: .  # Utiliser la racine du monorepo comme contexte
      dockerfile: apps/livreur/Dockerfile.prod
    container_name: livreurFrontendProd
    ports:
      - "3082:80"
    restart: unless-stopped
    networks:
      - app-network
  
  # Commercial frontend
  commercial-frontend:
    build:
      context: .  # Utiliser la racine du monorepo comme contexte
      dockerfile: apps/commercial/Dockerfile
    container_name: commercialFrontend
    ports:
      - "5178:5178"
    environment:
      - HOST=0.0.0.0
      - VITE_REDIRECT_URI_RESTAURATEUR=http://localhost:8080/commercial/
    volumes:
      - ./apps/commercial:/app/apps/commercial  # Adapter les volumes
      - /app/node_modules
      - /app/apps/commercial/node_modules  # Isoler les node_modules de l'app commercial
    networks:
      - app-network
    restart: unless-stopped
  
  # Developer frontend (Production)
  developer-frontend-prod:
    build:
      context: .  # Utiliser la racine du monorepo comme contexte
      dockerfile: apps/developer/Dockerfile.prod
    container_name: developerFrontendProd
    ports:
      - "3084:80"
    restart: unless-stopped
    networks:
      - app-network
  
  # Technical frontend (Production)
  technical-frontend-prod:
    build:
      context: .  # Utiliser la racine du monorepo comme contexte
      dockerfile: apps/technical/Dockerfile.prod
    container_name: technicalFrontendProd
    ports:
      - "3085:80"
    restart: unless-stopped
    networks:
      - app-network

  # Article Service
  article-service:
    build:
      context: ./services/articleService
      dockerfile: Dockerfile
    container_name: articleService
    ports:
      - "3005:3000"
    restart: unless-stopped
    networks:
      - app-network

  # Client Service
  client-service:
    build:
      context: ./services/clientService
      dockerfile: Dockerfile
    container_name: clientService
    ports:
      - "3000:3000"
    restart: unless-stopped
    networks:
      - app-network

  # Commande Service
  commande-service:
    build:
      context: ./services/commandeService
      dockerfile: Dockerfile
    container_name: commandeService
    restart: unless-stopped
    ports:
      - "3003:3000"
    networks:
      - app-network

  # Livreur Service
  livreur-service:
    build:
      context: ./services/livreurService
      dockerfile: Dockerfile
    container_name: livreurService
    restart: unless-stopped
    ports:
      - "3004:3000"
    networks:
      - app-network

  # Menu Service
  menu-service:
    build:
      context: ./services/menuService
      dockerfile: Dockerfile
    container_name: menuService
    restart: unless-stopped
    ports:
      - "3006:3000"
    networks:
      - app-network

  # Restaurateur Service
  restaurateur-service:
    build:
      context: ./services/restaurateurService
      dockerfile: Dockerfile
    container_name: restaurateurService
    restart: unless-stopped
    ports:
      - "3001:3000"
    networks:
      - app-network

  # Components Service
  component-service:
    build:
      context: ./services/componentService
      dockerfile: Dockerfile
    container_name: componentService
    restart: unless-stopped
    ports:
      - "3002:3002"  # IMPORTANT: changer le port expos√© pour correspondre au port interne
    volumes:
      - component_uploads:/app/uploads  # Corriger le chemin du volume
    networks:
      - app-network

networks:
  app-network:
    driver: bridge # Ensures proper communication between services

volumes:
  component_uploads:
  node_modules:
