events {
  worker_connections 1024;
}

http {
  upstream article_service {
    server articleService:3005;
  }

  upstream client_service {
    server clientService:3000;
  }

  upstream commande_service {
    server commandeService:3003;
  }

  upstream livreur_service {
    server livreurService:3004;
  }

  upstream menu_service {
    server menuService:3006;
  }

  upstream restaurateur_service {
    server restaurateurService:3001;
  }

  upstream client_frontend {
    server client-frontend:5173;
  }

  upstream livreur_frontend {
    server livreur-frontend:5175;
  }

  upstream restaurateur_frontend {
    server restaurateur-frontend:5174;
  }

  upstream developer_frontend {
    server developer-frontend:5176;
  }

  upstream technical_frontend {
    server technical-frontend:5177;
  }

  upstream cadvisor {
    server cadvisor:8080;  # Modifier le port ici - cAdvisor écoute sur 8080 à l'intérieur du container
  }


  server {
    listen 8080;

    # Frontend du client avec support WebSocket
    location /client/ {
      proxy_pass http://client_frontend/client/;
      
      # Configuration WebSocket
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_read_timeout 86400; # Temps d'attente élevé pour les connexions WebSocket
    }

    # Route spécifique pour WebSocket HMR
    location /client/ws {
      proxy_pass http://client_frontend/client/ws;
      
      # Configuration WebSocket
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_read_timeout 86400; # Temps d'attente élevé pour les connexions WebSocket
    }

    # Frontend du livreur
    location /livreur/ {
      proxy_pass http://livreur_frontend/livreur/;

            # Configuration WebSocket
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_read_timeout 86400; # Temps d'attente élevé pour les connexions WebSocket
    }

        # Route spécifique pour WebSocket HMR
    location /livreur/ws {
      proxy_pass http://livreur_frontend/livreur/ws;
      
      # Configuration WebSocket
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_read_timeout 86400; # Temps d'attente élevé pour les connexions WebSocket
    }

    # Frontend du restaurateur
    location /restaurateur/ {
      proxy_pass http://restaurateur_frontend/restaurateur/;

            # Configuration WebSocket
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_read_timeout 86400; # Temps d'attente élevé pour les connexions WebSocket
    }

        # Route spécifique pour WebSocket HMR
    location /restaurateur/ws {
      proxy_pass http://restaurateur_frontend/restaurateur/ws;
      
      # Configuration WebSocket
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_read_timeout 86400; # Temps d'attente élevé pour les connexions WebSocket
    }

    # Frontend du technique
    location /technical/ {
      proxy_pass http://technical_frontend/technical/;

            # Configuration WebSocket
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_read_timeout 86400; # Temps d'attente élevé pour les connexions WebSocket
    }

        # Route spécifique pour WebSocket HMR
    location /technical/ws {
      proxy_pass http://technical_frontend/technical/ws;
      
      # Configuration WebSocket
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_read_timeout 86400; # Temps d'attente élevé pour les connexions WebSocket
    }

    # Frontend developer
    location /developer/ {
      proxy_pass http://developer_frontend/developer/;

            # Configuration WebSocket
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_read_timeout 86400; # Temps d'attente élevé pour les connexions WebSocket
    }

    # Route spécifique pour WebSocket HMR
    location /developer/ws {
      proxy_pass http://developer_frontend/developer/ws;
      
      # Configuration WebSocket
      proxy_http_version 1.1;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_read_timeout 86400; # Temps d'attente élevé pour les connexions WebSocket
    }

    # API
    location /api/articles {
      proxy_pass http://article_service/api/articles;
    }

    location /api/clients {
      proxy_pass http://client_service/api/clients;
    }

    location /api/commandes {
      proxy_pass http://commande_service/api/commandes;
    }

    location /api/livreurs {
      proxy_pass http://livreur_service/api/livreurs;
    }

    location /api/menus {
      proxy_pass http://menu_service/api/menus;
    }

    location /api/restaurateurs {
      proxy_pass http://restaurateur_service/api/restaurateurs;
    }

    # CAdvisor - Configuration améliorée
    location /cadvisor/ {
      proxy_pass http://cadvisor/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_read_timeout 90;
    }

    # API cAdvisor - route spécifique pour l'API
    location /api/v1.3/ {
      proxy_pass http://cadvisor/api/v1.3/;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
    }
   
    
    # Redirection générique pour éviter les 404
    location /api {
      return 404;
    }

    
  }
}
